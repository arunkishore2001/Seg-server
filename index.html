<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Class Checker</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
textarea { width: 100%; height: 150px; }
.block {
    border: 1px solid #ccc;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
}
.block h3 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
button { padding: 5px 10px; }
pre {
    background: #f4f4f4;
    padding: 10px;
    white-space: pre-wrap;
}
</style>
</head>

<body>

<h2>Website Class Sorter (Section-aware)</h2>

<textarea id="inputLinks" placeholder="Paste links (one per line)"></textarea><br><br>
<button onclick="processLinks()">Process</button>

<div style="margin-top:20px;">
    <div style="background:#eee; height:20px; border-radius:5px;">
        <div id="progressBar" style="background:#4caf50; height:100%; width:0%; border-radius:5px;"></div>
    </div>
    <div id="results"></div>
</div>

<script>
async function processLinks() {
    const links = document.getElementById("inputLinks").value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

    console.clear();
    console.log("INPUT LINKS:", links);

    if (!links.length) {
        alert("Please enter links");
        return;
    }

    document.getElementById("results").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";

    const scrollBySection = {};
    const rhsBySection = {};
    const notPresentSet = new Set();
    const notFoundSet = new Set();

    let completed = 0;

    await Promise.allSettled(
        links.map(async (link) => {
            console.log("üîó Processing:", link);

            try {
                const res = await fetch("/api/check?url=" + encodeURIComponent(link));
                const data = await res.json();

                console.log("‚û°Ô∏è Status:", data.status);

                if (data.status === 404) {
                    console.warn("‚ùå 404:", link);
                    notFoundSet.add(link);
                    return;
                }

                if (!data.html) {
                    console.warn("‚ö†Ô∏è Empty HTML:", link);
                    notPresentSet.add(link);
                    return;
                }

                const doc = new DOMParser().parseFromString(data.html, "text/html");

                const allSections = Array.from(doc.querySelectorAll("section"));
                console.log("üì¶ Total <section> count:", allSections.length);

                const scrollDivs = Array.from(doc.querySelectorAll(".scroll"));
                console.log("üåÄ .scroll found:", scrollDivs.length);

                if (!scrollDivs.length) {
                    console.warn("üö´ No .scroll found:", link);
                    notPresentSet.add(link);
                    return;
                }

                scrollDivs.forEach((scrollDiv, i) => {
                    console.log(`‚û°Ô∏è Scroll index ${i + 1}`);

                    const parentSection = scrollDiv.closest("section");

                    if (!parentSection) {
                        console.warn("‚ùó scroll has NO parent <section>");
                        return;
                    }

                    const sectionNo = allSections.indexOf(parentSection) + 1;
                    console.log("üìç Scroll belongs to section:", sectionNo);

                    scrollBySection[sectionNo] ??= new Set();
                    scrollBySection[sectionNo].add(link);

                    const hasRhs = !!scrollDiv.querySelector(".rhs-cont");
                    console.log("‚û°Ô∏è rhs-cont inside scroll:", hasRhs);

                    if (hasRhs) {
                        rhsBySection[sectionNo] ??= new Set();
                        rhsBySection[sectionNo].add(link);
                    }
                });

            } catch (err) {
                console.error("üî• JS Error:", err);
                notPresentSet.add(link + " (‚ö†Ô∏è Error)");
            } finally {
                completed++;
                document.getElementById("progressBar").style.width =
                    Math.round((completed / links.length) * 100) + "%";
            }
        })
    );

    console.log("‚úÖ scrollBySection:", scrollBySection);
    console.log("‚úÖ rhsBySection:", rhsBySection);
    console.log("‚ùå notPresent:", [...notPresentSet]);
    console.log("‚ùå notFound:", [...notFoundSet]);

    renderSectionBlocks("scroll", scrollBySection);
    renderSectionBlocks("rhs-cont", rhsBySection);
    renderSimpleBlock("not present", [...notPresentSet]);
    renderSimpleBlock("404 not found", [...notFoundSet]);
}

/* ---------- UI helpers ---------- */

function renderSectionBlocks(title, data) {
    Object.keys(data)
        .sort((a, b) => a - b)
        .forEach(sectionNo => {
            const block = document.createElement("div");
            block.className = "block";

            block.innerHTML = `
                <h3>${title} (Section ${sectionNo})
                    <button onclick="copyDynamic(this)">Copy</button>
                </h3>
                <pre>${[...data[sectionNo]].join("\n")}</pre>
            `;
            document.getElementById("results").appendChild(block);
        });
}

function renderSimpleBlock(title, links) {
    if (!links.length) return;

    const block = document.createElement("div");
    block.className = "block";

    block.innerHTML = `
        <h3>${title}
            <button onclick="copyDynamic(this)">Copy</button>
        </h3>
        <pre>${links.join("\n")}</pre>
    `;
    document.getElementById("results").appendChild(block);
}

function copyDynamic(btn) {
    const text = btn.closest(".block").querySelector("pre").textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>


</body>
</html>
