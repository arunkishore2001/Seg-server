<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Class Sorter</title>

<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; }
    .block { border: 1px solid #ccc; padding: 10px; margin-top: 15px; border-radius: 5px; }
    .block h3 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
    button { padding: 5px 10px; cursor: pointer; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
</style>
</head>

<body>

<h2>Website Class Sorter (Section-wise)</h2>

<textarea id="inputLinks" placeholder="Paste your links here (one per line)"></textarea><br><br>
<button onclick="processLinks()">Process</button>

<div style="margin-top:20px;">
    <div style="background:#eee; border-radius:5px; height:20px; width:100%; margin-bottom:10px;">
        <div id="progressBar" style="background:#4caf50; height:100%; width:0%; border-radius:5px;"></div>
    </div>
    <div id="results"></div>
</div>

<script>
async function processLinks() {
    const links = document.getElementById("inputLinks").value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

    if (!links.length) {
        alert("Please enter links");
        return;
    }

    document.getElementById("results").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";

    const scrollBySection = {};
    const rhsBySection = {};
    const globalNotPresent = [];

    let completed = 0;

    const requests = links.map(async (link) => {
        let foundAnything = false;

        try {
            const res = await fetch("/api/check?url=" + encodeURIComponent(link));
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, "text/html");
            const sections = Array.from(doc.querySelectorAll("section"));

            sections.forEach((section, index) => {
                const sectionNo = index + 1;

                const hasScroll = section.querySelector(".scroll");
                const hasRhs = section.querySelector(".rhs-cont");

                if (hasScroll) {
                    scrollBySection[sectionNo] ??= new Set();
                    scrollBySection[sectionNo].add(link);
                    foundAnything = true;
                }

                if (hasRhs) {
                    rhsBySection[sectionNo] ??= new Set();
                    rhsBySection[sectionNo].add(link);
                    foundAnything = true;
                }
            });

            if (!foundAnything) {
                globalNotPresent.push(link);
            }

        } catch (err) {
            globalNotPresent.push(link + " (⚠️ Error)");
        } finally {
            completed++;
            document.getElementById("progressBar").style.width =
                Math.round((completed / links.length) * 100) + "%";
        }
    });

    await Promise.allSettled(requests);

    renderSectionBlocks("scroll present", scrollBySection);
    renderSectionBlocks("rhs-cont", rhsBySection);
    renderSimpleBlock("not present (no scroll & no rhs)", globalNotPresent);
}

/* ---------- UI HELPERS ---------- */

function renderSectionBlocks(title, data) {
    Object.keys(data)
        .sort((a, b) => a - b)
        .forEach(sectionNo => {
            const block = document.createElement("div");
            block.className = "block";

            block.innerHTML = `
                <h3>${title} – Section ${sectionNo}
                    <button onclick="copyDynamic(this)">Copy</button>
                </h3>
                <pre>${Array.from(data[sectionNo]).join("\n")}</pre>
            `;

            document.getElementById("results").appendChild(block);
        });
}

function renderSimpleBlock(title, links) {
    if (!links.length) return;

    const block = document.createElement("div");
    block.className = "block";

    block.innerHTML = `
        <h3>${title}
            <button onclick="copyDynamic(this)">Copy</button>
        </h3>
        <pre>${links.join("\n")}</pre>
    `;

    document.getElementById("results").appendChild(block);
}

function copyDynamic(btn) {
    const text = btn.closest(".block").querySelector("pre").textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>

</body>
</html>
