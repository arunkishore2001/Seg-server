<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Class Sorter</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
textarea { width: 100%; height: 150px; }
.block {
    border: 1px solid #ccc;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
}
.block h3 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
button { padding: 5px 10px; cursor:pointer; }
pre {
    background: #f4f4f4;
    padding: 10px;
    white-space: pre-wrap;
}
.progress-container {
    background:#eee;
    height:20px;
    border-radius:5px;
    margin-top:20px;
}
#progressBar {
    background:#4caf50;
    height:100%;
    width:0%;
    border-radius:5px;
}
</style>
</head>

<body>

<h2>Website Class Sorter (Grouped by Section)</h2>

<textarea id="inputLinks" placeholder="Paste links (one per line)"></textarea><br><br>
<button onclick="processLinks()">Process</button>

<div class="progress-container">
    <div id="progressBar"></div>
</div>

<div id="results"></div>

<script>
async function processLinks() {

    const links = document.getElementById("inputLinks").value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

    if (!links.length) {
        alert("Please enter links");
        return;
    }

    document.getElementById("results").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";

    const lhsBySection = {};     // LHS grouped by section
    const nolhsBySection = {};   // NOLHS grouped by section
    const notPresentSet = new Set();
    const notFoundSet = new Set();

    let completed = 0;

    await Promise.allSettled(
        links.map(async (link) => {

            try {

                const res = await fetch("/api/check?url=" + encodeURIComponent(link));
                const data = await res.json();

                if (data.status === 404) {
                    notFoundSet.add(link);
                    return;
                }

                if (!data.html) {
                    notPresentSet.add(link);
                    return;
                }

                const doc = new DOMParser().parseFromString(data.html, "text/html");
                const allSections = Array.from(doc.querySelectorAll("section"));
                const scrollDivs = Array.from(doc.querySelectorAll("#scroll, .scroll"));

                if (!scrollDivs.length) {
                    notPresentSet.add(link);
                    return;
                }

                scrollDivs.forEach(scrollDiv => {

                    const parentSection = scrollDiv.closest("section");
                    if (!parentSection) return;

                    const sectionNo = allSections.indexOf(parentSection) + 1;
                    if (sectionNo < 1) return;

                    const hasRhs = scrollDiv.querySelector(".rhs-cont");

                    if (hasRhs) {
                        lhsBySection[sectionNo] ??= new Set();
                        lhsBySection[sectionNo].add(link);
                    } else {
                        nolhsBySection[sectionNo] ??= new Set();
                        nolhsBySection[sectionNo].add(link);
                    }
                });

            } catch {
                notPresentSet.add(link + " (⚠️ Error)");
            } finally {
                completed++;
                document.getElementById("progressBar").style.width =
                    Math.round((completed / links.length) * 100) + "%";
            }
        })
    );

    renderSectionBlocks("LHS Template", lhsBySection);
    renderSectionBlocks("NOLHS Template", nolhsBySection);
    renderSimpleBlock("Not Present (#scroll missing)", [...notPresentSet]);
    renderSimpleBlock("404 Not Found", [...notFoundSet]);
}


/* ---------- Render Helpers ---------- */

function renderSectionBlocks(title, data) {

    Object.keys(data)
        .sort((a,b)=>a-b)
        .forEach(sectionNo => {

            const block = document.createElement("div");
            block.className = "block";

            block.innerHTML = `
                <h3>${title} (Section ${sectionNo})
                    <button onclick="copyDynamic(this)">Copy</button>
                </h3>
                <pre>${[...data[sectionNo]].join("\n")}</pre>
            `;

            document.getElementById("results").appendChild(block);
        });
}


function renderSimpleBlock(title, links) {

    if (!links.length) return;

    const block = document.createElement("div");
    block.className = "block";

    block.innerHTML = `
        <h3>${title}
            <button onclick="copyDynamic(this)">Copy</button>
        </h3>
        <pre>${links.join("\n")}</pre>
    `;

    document.getElementById("results").appendChild(block);
}


function copyDynamic(btn) {
    const text = btn.closest(".block").querySelector("pre").textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>

</body>
</html>
