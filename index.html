<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Website Class Sorter</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
textarea { width: 100%; height: 150px; }
.block {
    border: 1px solid #ccc;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
}
.block h3 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
button { padding: 5px 10px; cursor:pointer; }
pre {
    background: #f4f4f4;
    padding: 10px;
    white-space: pre-wrap;
}
.progress-container {
    background:#eee;
    height:20px;
    border-radius:5px;
    margin-top:20px;
}
#progressBar {
    background:#4caf50;
    height:100%;
    width:0%;
    border-radius:5px;
}
.url-line {
    margin-bottom:8px;
}
.section-badge {
    background:#4caf50;
    color:#fff;
    padding:2px 6px;
    border-radius:4px;
    font-size:12px;
    margin-left:5px;
}
</style>
</head>

<body>

<h2>Website Class Sorter (LHS / NOLHS with Section Count)</h2>

<textarea id="inputLinks" placeholder="Paste links (one per line)"></textarea><br><br>
<button onclick="processLinks()">Process</button>

<div class="progress-container">
    <div id="progressBar"></div>
</div>

<div id="results"></div>

<script>
async function processLinks() {

    const links = document.getElementById("inputLinks").value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

    if (!links.length) {
        alert("Please enter links");
        return;
    }

    document.getElementById("results").innerHTML = "";
    document.getElementById("progressBar").style.width = "0%";

    const nolhsMap = {};   // { url: [sections] }
    const lhsMap = {};     // { url: [sections] }
    const notPresentSet = new Set();
    const notFoundSet = new Set();

    let completed = 0;

    await Promise.allSettled(
        links.map(async (link) => {

            try {

                const res = await fetch("/api/check?url=" + encodeURIComponent(link));
                const data = await res.json();

                if (data.status === 404) {
                    notFoundSet.add(link);
                    return;
                }

                if (!data.html) {
                    notPresentSet.add(link);
                    return;
                }

                const doc = new DOMParser().parseFromString(data.html, "text/html");
                const allSections = Array.from(doc.querySelectorAll("section"));
                const scrollDivs = Array.from(doc.querySelectorAll("#scroll, .scroll"));

                if (!scrollDivs.length) {
                    notPresentSet.add(link);
                    return;
                }

                scrollDivs.forEach(scrollDiv => {

                    const parentSection = scrollDiv.closest("section");
                    if (!parentSection) return;

                    const sectionNo = allSections.indexOf(parentSection) + 1;
                    if (sectionNo < 1) return;

                    const hasRhs = scrollDiv.querySelector(".rhs-cont");

                    if (hasRhs) {
                        lhsMap[link] ??= new Set();
                        lhsMap[link].add(sectionNo);
                    } else {
                        nolhsMap[link] ??= new Set();
                        nolhsMap[link].add(sectionNo);
                    }
                });

            } catch {
                notPresentSet.add(link + " (⚠️ Error)");
            } finally {
                completed++;
                document.getElementById("progressBar").style.width =
                    Math.round((completed / links.length) * 100) + "%";
            }
        })
    );

    renderUrlSectionBlock("NOLHS Template", nolhsMap, "#ff9800");
    renderUrlSectionBlock("LHS Template", lhsMap, "#4caf50");
    renderSimpleBlock("Not Present (#scroll missing)", [...notPresentSet]);
    renderSimpleBlock("404 Not Found", [...notFoundSet]);
}


/* ---------- Render Helpers ---------- */

function renderUrlSectionBlock(title, data, color) {

    if (!Object.keys(data).length) return;

    const block = document.createElement("div");
    block.className = "block";

    const lines = [];

    Object.keys(data).forEach(url => {

        const sections = [...data[url]].sort((a,b)=>a-b);

        lines.push(
            `${url} → Section ${sections.join(", ")}`
        );
    });

    block.innerHTML = `
        <h3>${title}
            <button onclick="copyDynamic(this)">Copy</button>
        </h3>
        <pre>${lines.join("\n")}</pre>
    `;

    document.getElementById("results").appendChild(block);
}


function renderSimpleBlock(title, links) {

    if (!links.length) return;

    const block = document.createElement("div");
    block.className = "block";

    block.innerHTML = `
        <h3>${title}
            <button onclick="copyDynamic(this)">Copy</button>
        </h3>
        <pre>${links.join("\n")}</pre>
    `;

    document.getElementById("results").appendChild(block);
}


function copyDynamic(btn) {
    const text = btn.closest(".block").querySelector("pre").textContent;
    navigator.clipboard.writeText(text).then(() => alert("Copied!"));
}
</script>

</body>
</html>
